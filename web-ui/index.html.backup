<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PG-View Knowledge Graph Manager</title>
    <!-- vis.js for graph visualization -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        .nav-button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: #f3f4f6;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s;
        }

        .nav-button:hover {
            background: #e5e7eb;
        }

        .nav-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .content h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 120px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .result-box {
            margin-top: 20px;
            padding: 20px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .result-box pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #1f2937;
        }

        .success {
            padding: 15px;
            background: #d1fae5;
            border: 2px solid #10b981;
            border-radius: 8px;
            color: #065f46;
            margin-bottom: 20px;
        }

        .error {
            padding: 15px;
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            color: #991b1b;
            margin-bottom: 20px;
        }

        .info {
            padding: 15px;
            background: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            color: #1e40af;
            margin-bottom: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .card {
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #374151;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .table th {
            background: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîÆ PG-View Knowledge Graph Manager</h1>
            <p style="color: #6b7280; margin-bottom: 10px;">Interactive interface for managing property graphs and views</p>
            <div class="status">
                <span class="status-dot"></span>
                <span id="statusText" style="color: #10b981; font-weight: 600;">Connected to API Server</span>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Sidebar Navigation -->
            <div class="sidebar">
                <h2>Navigation</h2>
                <button class="nav-button active" onclick="showSection('connection')">üîå Connection</button>
                <button class="nav-button" onclick="showSection('graphs')">üìä Graphs</button>
                <button class="nav-button" onclick="showSection('schema')">üèóÔ∏è Schema</button>
                <button class="nav-button" onclick="showSection('data')">üìù Data</button>
                <button class="nav-button" onclick="showSection('query')">üîç Query</button>
                <button class="nav-button" onclick="showSection('views')">üëÅÔ∏è Views</button>
                <button class="nav-button" onclick="showSection('visualize')">üìà Visualize</button>
                <button class="nav-button" onclick="showSection('explore')">üó∫Ô∏è Explore</button>
            </div>

            <!-- Main Content -->
            <div class="content">
                <!-- Connection Section -->
                <div id="section-connection" class="section">
                    <h2>Connection Settings</h2>
                    <div class="info">
                        <strong>üí° Tip:</strong> Choose your backend platform. PostgreSQL for production, SimpleDatalog for testing.
                    </div>
                    
                    <div class="form-group">
                        <label>Backend Platform</label>
                        <select id="platform">
                            <option value="pg">PostgreSQL (Production)</option>
                            <option value="sd">SimpleDatalog (Testing)</option>
                            <option value="lb">LogicBlox (Advanced)</option>
                            <option value="n4">Neo4j (Graph DB)</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="connectPlatform()">Connect to Backend</button>
                    <button class="btn btn-secondary" onclick="checkHealth()">Check Server Health</button>

                    <div id="connectionResult" class="result-box hidden"></div>
                </div>

                <!-- Graphs Section -->
                <div id="section-graphs" class="section hidden">
                    <h2>Graph Management</h2>
                    
                    <div class="grid-2">
                        <div class="card">
                            <h3>Create New Graph</h3>
                            <div class="form-group">
                                <label>Graph Name</label>
                                <input type="text" id="newGraphName" placeholder="e.g., MyKnowledgeGraph">
                            </div>
                            <button class="btn btn-success" onclick="createGraph()">Create Graph</button>
                        </div>

                        <div class="card">
                            <h3>Use Existing Graph</h3>
                            <div class="form-group">
                                <label>Graph Name</label>
                                <input type="text" id="useGraphName" placeholder="Enter graph name">
                            </div>
                            <button class="btn btn-primary" onclick="useGraph()">Use Graph</button>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="listGraphs()">List All Graphs</button>
                    </div>

                    <div id="graphsResult" class="result-box hidden"></div>
                </div>

                <!-- Schema Section -->
                <div id="section-schema" class="section hidden">
                    <h2>Schema Management</h2>
                    
                    <div class="grid-2">
                        <div class="card">
                            <h3>Add Node Type</h3>
                            <div class="form-group">
                                <label>Node Label</label>
                                <input type="text" id="nodeLabel" placeholder="e.g., Person, Entity, Document">
                            </div>
                            <button class="btn btn-success" onclick="addNodeSchema()">Add Node Type</button>
                        </div>

                        <div class="card">
                            <h3>Add Edge Type</h3>
                            <div class="form-group">
                                <label>Edge Label</label>
                                <input type="text" id="edgeLabel" placeholder="e.g., Knows, RelatesTo">
                            </div>
                            <div class="form-group">
                                <label>From Node Type</label>
                                <input type="text" id="edgeFrom" placeholder="Source node type">
                            </div>
                            <div class="form-group">
                                <label>To Node Type</label>
                                <input type="text" id="edgeTo" placeholder="Target node type">
                            </div>
                            <button class="btn btn-success" onclick="addEdgeSchema()">Add Edge Type</button>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="getSchema()">View Current Schema</button>
                    </div>

                    <div id="schemaResult" class="result-box hidden"></div>
                </div>

                <!-- Data Section -->
                <div id="section-data" class="section hidden">
                    <h2>Data Management</h2>
                    
                    <div class="quick-actions">
                        <button class="btn btn-secondary" onclick="showDataForm('node')">Add Node</button>
                        <button class="btn btn-secondary" onclick="showDataForm('edge')">Add Edge</button>
                        <button class="btn btn-secondary" onclick="showDataForm('property')">Add Property</button>
                        <button class="btn btn-secondary" onclick="showDataForm('raw')">Raw Insert</button>
                    </div>

                    <!-- Node Form -->
                    <div id="dataForm-node" class="card hidden">
                        <h3>Insert Node</h3>
                        <div class="form-group">
                            <label>Node ID</label>
                            <input type="number" id="nodeId" placeholder="e.g., 1">
                        </div>
                        <div class="form-group">
                            <label>Node Label</label>
                            <input type="text" id="nodeDataLabel" placeholder="e.g., Person">
                        </div>
                        <button class="btn btn-success" onclick="insertNode()">Insert Node</button>
                    </div>

                    <!-- Edge Form -->
                    <div id="dataForm-edge" class="card hidden">
                        <h3>Insert Edge</h3>
                        <div class="form-group">
                            <label>Edge ID</label>
                            <input type="number" id="edgeId" placeholder="e.g., 10">
                        </div>
                        <div class="form-group">
                            <label>From Node ID</label>
                            <input type="number" id="edgeFromId" placeholder="Source node">
                        </div>
                        <div class="form-group">
                            <label>To Node ID</label>
                            <input type="number" id="edgeToId" placeholder="Target node">
                        </div>
                        <div class="form-group">
                            <label>Edge Label</label>
                            <input type="text" id="edgeDataLabel" placeholder="e.g., Knows">
                        </div>
                        <button class="btn btn-success" onclick="insertEdge()">Insert Edge</button>
                    </div>

                    <!-- Property Form -->
                    <div id="dataForm-property" class="card hidden">
                        <h3>Insert Property</h3>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="propType">
                                <option value="NP">Node Property</option>
                                <option value="EP">Edge Property</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Element ID</label>
                            <input type="number" id="propId" placeholder="Node or Edge ID">
                        </div>
                        <div class="form-group">
                            <label>Property Name</label>
                            <input type="text" id="propName" placeholder="e.g., name, age">
                        </div>
                        <div class="form-group">
                            <label>Property Value</label>
                            <input type="text" id="propValue" placeholder="e.g., Alice, 30">
                        </div>
                        <button class="btn btn-success" onclick="insertProperty()">Insert Property</button>
                    </div>

                    <!-- Raw Insert Form -->
                    <div id="dataForm-raw" class="card hidden">
                        <h3>Raw Insert Command</h3>
                        <div class="form-group">
                            <label>Relation Name</label>
                            <input type="text" id="rawRelName" placeholder="N, E, NP, or EP">
                        </div>
                        <div class="form-group">
                            <label>Arguments</label>
                            <input type="text" id="rawArgs" placeholder='e.g., 1,"Person" or 10,1,2,"Knows"'>
                        </div>
                        <button class="btn btn-success" onclick="insertRaw()">Execute Insert</button>
                    </div>

                    <div id="dataResult" class="result-box hidden"></div>
                </div>

                <!-- Query Section -->
                <div id="section-query" class="section hidden">
                    <h2>Query Graph</h2>
                    
                    <div class="info">
                        <strong>üí° Examples:</strong><br>
                        <code>MATCH (a:Person)-[x:Knows]->(b:Person) FROM g RETURN (a),(b),(x)</code><br>
                        <code>MATCH (e:Entity) FROM g WHERE e.name = "Alice" RETURN (e)</code>
                    </div>

                    <div class="form-group">
                        <label>GQL Query</label>
                        <textarea id="queryText" placeholder="Enter your GQL query here..."></textarea>
                    </div>

                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="executeQuery()">Execute Query</button>
                        <button class="btn btn-secondary" onclick="loadSampleQuery('basic')">Sample: Basic Match</button>
                        <button class="btn btn-secondary" onclick="loadSampleQuery('properties')">Sample: With Properties</button>
                    </div>

                    <div id="queryResult" class="result-box hidden"></div>
                </div>

                <!-- Views Section -->
                <div id="section-views" class="section hidden">
                    <h2>View Management</h2>
                    
                    <div class="info">
                        <strong>üí° Create Views:</strong> Define derived graphs with transformations, filters, or derived relationships.
                    </div>

                    <div class="form-group">
                        <label>View Definition (GQL)</label>
                        <textarea id="viewDefinition" placeholder='CREATE virtual VIEW MyView ON g (&#10;  MATCH (a:Person)-[x:Knows]->(b:Person)&#10;)'></textarea>
                    </div>

                    <div class="quick-actions">
                        <button class="btn btn-success" onclick="createView()">Create View</button>
                        <button class="btn btn-secondary" onclick="listViews()">List All Views</button>
                        <button class="btn btn-secondary" onclick="loadSampleView('selection')">Sample: Selection View</button>
                        <button class="btn btn-secondary" onclick="loadSampleView('transformation')">Sample: Transformation</button>
                    </div>

                    <div id="viewsResult" class="result-box hidden"></div>
                </div>

                <!-- Visualization Section -->
                <div id="section-visualize" class="section hidden">
                    <h2>Graph Visualization</h2>
                
                    <div class="info">
                        <strong>üìà Visualize:</strong> View your graph data, views, and query results as interactive network diagrams.
                    </div>
                
                    <div class="form-group">
                        <label>Visualization Source</label>
                        <select id="vizSource" onchange="updateVizOptions()">
                            <option value="base">Base Graph (All Data)</option>
                            <option value="view">View</option>
                            <option value="query">Custom Query</option>
                        </select>
                    </div>
                
                    <div id="vizViewOptions" class="form-group hidden">
                        <label>Select View</label>
                        <select id="vizViewName">
                            <option value="">-- Select View --</option>
                        </select>
                    </div>
                
                    <div id="vizQueryOptions" class="form-group hidden">
                        <label>Query (MATCH ... RETURN)</label>
                        <textarea id="vizQuery"
                            placeholder='MATCH (a:Person)-[x:knows]->(b:Person) FROM g RETURN (a),(x),(b)'></textarea>
                    </div>
                
                    <div class="form-group">
                        <label>Limit Nodes (for performance)</label>
                        <input type="number" id="vizLimit" value="100" min="10" max="1000">
                    </div>
                
                    <div class="quick-actions">
                        <button class="btn btn-success" onclick="visualizeGraph()">üé® Visualize</button>
                        <button class="btn btn-secondary" onclick="clearVisualization()">üóëÔ∏è Clear</button>
                        <button class="btn btn-secondary" onclick="exportVisualization()">üíæ Export PNG</button>
                    </div>
                
                    <div id="graphContainer"
                        style="width: 100%; height: 600px; border: 2px solid #e5e7eb; border-radius: 8px; margin-top: 20px; background: #f9fafb;">
                    </div>
                
                    <div id="vizStats" class="result-box hidden" style="margin-top: 15px;"></div>
                </div>

                <!-- Explore Section -->
                <div id="section-explore" class="section hidden">
                    <h2>Explore Database</h2>
                    
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="exploreSchema()">üìã Show Schema</button>
                        <button class="btn btn-primary" onclick="exploreViews()">üëÅÔ∏è Show Views</button>
                        <button class="btn btn-primary" onclick="exploreProgram()">üîß Show Datalog Program</button>
                        <button class="btn btn-secondary" onclick="quickStats()">üìä Quick Stats</button>
                    </div>

                    <div id="exploreResult" class="result-box hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:7070';
        let currentPlatform = 'lb';
        let currentGraph = null;

        // Show/Hide sections
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`section-${sectionName}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // API Helper
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method: method,
                    headers: {'Content-Type': 'application/json'}
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }
                const response = await fetch(`${API_URL}${endpoint}`, options);
                return await response.json();
            } catch (error) {
                return {success: false, error: error.message};
            }
        }

        // Show result
        function showResult(elementId, data, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.classList.remove('hidden');
            
            if (typeof data === 'object') {
                element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } else {
                element.innerHTML = `<pre>${data}</pre>`;
            }
        }

        // Connection functions
        async function checkHealth() {
            const result = await apiCall('/health');
            showResult('connectionResult', result);
        }

        async function connectPlatform() {
            const platform = document.getElementById('platform').value;
            const result = await apiCall('/connect', 'POST', {platform});
            currentPlatform = platform;
            showResult('connectionResult', result);
        }

        // Graph functions
        async function createGraph() {
            const name = document.getElementById('newGraphName').value;
            if (!name) {
                alert('Please enter a graph name');
                return;
            }
            const result = await apiCall('/graph/create', 'POST', {name});
            currentGraph = name;
            showResult('graphsResult', result);
        }

        async function useGraph() {
            const name = document.getElementById('useGraphName').value;
            if (!name) {
                alert('Please enter a graph name');
                return;
            }
            const result = await apiCall('/graph/use', 'POST', {name});
            currentGraph = name;
            showResult('graphsResult', result);
        }

        async function listGraphs() {
            const result = await apiCall('/graphs');
            showResult('graphsResult', result);
        }

        // Schema functions
        async function addNodeSchema() {
            const label = document.getElementById('nodeLabel').value;
            if (!label) {
                alert('Please enter a node label');
                return;
            }
            const result = await apiCall('/schema/node', 'POST', {label});
            showResult('schemaResult', result);
        }

        async function addEdgeSchema() {
            const label = document.getElementById('edgeLabel').value;
            const from = document.getElementById('edgeFrom').value;
            const to = document.getElementById('edgeTo').value;
            if (!label || !from || !to) {
                alert('Please fill all fields');
                return;
            }
            const result = await apiCall('/schema/edge', 'POST', {label, from, to});
            showResult('schemaResult', result);
        }

        async function getSchema() {
            const result = await apiCall('/schema');
            showResult('schemaResult', result);
        }

        // Data functions
        function showDataForm(formType) {
            document.querySelectorAll('[id^="dataForm-"]').forEach(form => {
                form.classList.add('hidden');
            });
            document.getElementById(`dataForm-${formType}`).classList.remove('hidden');
        }

        async function insertNode() {
            const id = document.getElementById('nodeId').value;
            const label = document.getElementById('nodeDataLabel').value;
            if (!id || !label) {
                alert('Please fill all fields');
                return;
            }
            const result = await apiCall('/data/insert', 'POST', {
                relName: 'N',
                args: `${id},"${label}"`
            });
            showResult('dataResult', result);
        }

        async function insertEdge() {
            const id = document.getElementById('edgeId').value;
            const from = document.getElementById('edgeFromId').value;
            const to = document.getElementById('edgeToId').value;
            const label = document.getElementById('edgeDataLabel').value;
            if (!id || !from || !to || !label) {
                alert('Please fill all fields');
                return;
            }
            const result = await apiCall('/data/insert', 'POST', {
                relName: 'E',
                args: `${id},${from},${to},"${label}"`
            });
            showResult('dataResult', result);
        }

        async function insertProperty() {
            const type = document.getElementById('propType').value;
            const id = document.getElementById('propId').value;
            const name = document.getElementById('propName').value;
            const value = document.getElementById('propValue').value;
            if (!id || !name || !value) {
                alert('Please fill all fields');
                return;
            }
            const result = await apiCall('/data/insert', 'POST', {
                relName: type,
                args: `${id},"${name}","${value}"`
            });
            showResult('dataResult', result);
        }

        async function insertRaw() {
            const relName = document.getElementById('rawRelName').value;
            const args = document.getElementById('rawArgs').value;
            if (!relName || !args) {
                alert('Please fill all fields');
                return;
            }
            const result = await apiCall('/data/insert', 'POST', {relName, args});
            showResult('dataResult', result);
        }

        // Query functions
        async function executeQuery() {
            const query = document.getElementById('queryText').value;
            if (!query) {
                alert('Please enter a query');
                return;
            }
            const result = await apiCall('/query', 'POST', {query});
            showResult('queryResult', result);
        }

        function loadSampleQuery(type) {
            const queries = {
                basic: 'MATCH (a:Person)-[x:Knows]->(b:Person) FROM g RETURN (a),(b),(x)',
                properties: 'MATCH (e:Entity) FROM g WHERE e.name = "Alice" RETURN (e)'
            };
            document.getElementById('queryText').value = queries[type];
        }

        // View functions
        async function createView() {
            const definition = document.getElementById('viewDefinition').value;
            if (!definition) {
                alert('Please enter a view definition');
                return;
            }
            const result = await apiCall('/view/create', 'POST', {definition});
            showResult('viewsResult', result);
        }

        async function listViews() {
            const result = await apiCall('/views');
            showResult('viewsResult', result);
        }

        function loadSampleView(type) {
            const views = {
                selection: `CREATE virtual VIEW PersonView ON g (
  MATCH (p:Person)-[k:Knows]->(p2:Person)
)`,
                transformation: `CREATE virtual VIEW UserNetwork ON g WITH DEFAULT MAP (
  MATCH (p:Person)-[k:Knows]->(p2:Person)
  CONSTRUCT (p:User)-[c:ConnectedTo]->(p2:User)
)`
            };
            document.getElementById('viewDefinition').value = views[type];
        }

        // Explore functions
        async function exploreSchema() {
            const result = await apiCall('/schema');
            showResult('exploreResult', result);
        }

        async function exploreViews() {
            const result = await apiCall('/views');
            showResult('exploreResult', result);
        }

        async function exploreProgram() {
            const result = await apiCall('/program');
            showResult('exploreResult', result);
        }

        async function quickStats() {
            const schemaResult = await apiCall('/schema');
            const viewsResult = await apiCall('/views');
            
            const stats = {
                platform: currentPlatform,
                currentGraph: currentGraph || 'None',
                schema: schemaResult,
                views: viewsResult
            };
            
            showResult('exploreResult', stats);
        }

            // Visualization Functions
            let network = null;
            let visualizationData = null;

            function updateVizOptions() {
                const source = document.getElementById('vizSource').value;
                const viewOptions = document.getElementById('vizViewOptions');
                const queryOptions = document.getElementById('vizQueryOptions');

                if (source === 'view') {
                    viewOptions.classList.remove('hidden');
                    queryOptions.classList.add('hidden');
                    loadViewsForVisualization();
                } else if (source === 'query') {
                    viewOptions.classList.add('hidden');
                    queryOptions.classList.remove('hidden');
                } else {
                    viewOptions.classList.add('hidden');
                    queryOptions.classList.add('hidden');
                }
            }

            async function loadViewsForVisualization() {
                try {
                    const response = await fetch(`${API_URL}/views`);
                    const result = await response.json();

                    if (result.success && result.views) {
                        const select = document.getElementById('vizViewName');
                        select.innerHTML = '<option value="">-- Select View --</option>';

                        const viewMatches = result.views.match(/viewName: (\w+)/g);
                        if (viewMatches) {
                            viewMatches.forEach(match => {
                                const viewName = match.replace('viewName: ', '');
                                select.innerHTML += `<option value="${viewName}">${viewName}</option>`;
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading views:', error);
                }
            }

            async function visualizeGraph() {
                const source = document.getElementById('vizSource').value;
                const limit = parseInt(document.getElementById('vizLimit').value);

                showResult('vizStats', '‚è≥ Loading data...');

                try {
                    // Get current graph status
                    const statusResponse = await fetch(`${API_URL}/status`);
                    const status = await statusResponse.json();
                    
                    if (!status.currentGraph) {
                        showResult('vizStats', '‚ö†Ô∏è Please select a database first');
                        return;
                    }

                    let fromClause = 'g';
                    
                    if (source === 'view') {
                        const viewName = document.getElementById('vizViewName').value;
                        if (!viewName) {
                            showResult('vizStats', '‚ö†Ô∏è Please select a view');
                            return;
                        }
                        fromClause = viewName;
                    } else if (source === 'query') {
                        const customQuery = document.getElementById('vizQuery').value.trim();
                        if (customQuery) {
                            // Execute custom query directly
                            await executeCustomQueryVisualization(customQuery, limit);
                            return;
                        }
                    }

                    // Fetch real data from PostgreSQL via API
                    await visualizeFromDatabase(fromClause, limit);

                } catch (error) {
                    showResult('vizStats', `‚ùå Error: ${error.message}`);
                    console.error('Visualization error:', error);
                }
            }

            async function visualizeFromDatabase(fromClause, limit) {
                try {
                    showResult('vizStats', '‚è≥ Fetching graph data...');
                    
                    // Use the new visualization endpoint for base graph
                    if (fromClause === 'g') {
                        const response = await fetch(`${API_URL}/visualize/graph?limit=${limit}`);
                        const result = await response.json();
                        
                        if (!result.success) {
                            throw new Error(result.error || 'Failed to fetch visualization data');
                        }
                        
                        renderVisualizationFromAPI(result.nodes, result.edges);
                    } else {
                        // For views, use the visualization endpoint with view parameter
                        const viewName = fromClause;
                        const response = await fetch(`${API_URL}/visualize/graph?limit=${limit}&view=${viewName}`);
                        const result = await response.json();
                        
                        if (result.success) {
                            renderVisualizationFromAPI(result.nodes, result.edges);
                        } else {
                            showResult('vizStats', `‚ùå Error visualizing view: ${result.error}<br><br>üí° Tip: Try using "Base Graph" source.`);
                        }
                    }

                } catch (error) {
                    console.error('Error fetching from database:', error);
                    showResult('vizStats', `‚ùå Error: ${error.message}`);
                }
            }
            
            function renderVisualizationFromAPI(apiNodes, apiEdges) {
                const nodes = [];
                const edges = [];
                
                const colors = {
                    'Person': '#667eea',
                    'Company': '#10b981',
                    'Product': '#f59e0b',
                    'default': '#94a3b8'
                };
                
                const shapes = {
                    'Person': 'dot',
                    'Company': 'diamond',
                    'Product': 'square',
                    'default': 'dot'
                };
                
                // Process nodes
                apiNodes.forEach(node => {
                    let title = `Type: ${node.label}<br>ID: ${node.id}`;
                    
                    // Add properties to tooltip
                    if (node.properties) {
                        title += '<br>---';
                        for (const [key, value] of Object.entries(node.properties)) {
                            title += `<br>${key}: ${value}`;
                        }
                    }
                    
                    // Create display label
                    let displayLabel = node.label;
                    if (node.properties && node.properties.name) {
                        displayLabel = node.properties.name;
                    }
                    
                    nodes.push({
                        id: node.id,
                        label: displayLabel,
                        title: title,
                        color: colors[node.label] || colors['default'],
                        shape: shapes[node.label] || shapes['default'],
                        size: 25
                    });
                });
                
                // Process edges
                apiEdges.forEach(edge => {
                    let title = `Type: ${edge.label}<br>ID: ${edge.id}`;
                    
                    // Add properties to tooltip
                    if (edge.properties) {
                        title += '<br>---';
                        for (const [key, value] of Object.entries(edge.properties)) {
                            title += `<br>${key}: ${value}`;
                        }
                    }
                    
                    edges.push({
                        id: edge.id,
                        from: edge.from,
                        to: edge.to,
                        label: edge.label,
                        title: title,
                        arrows: 'to',
                        color: { color: '#666' },
                        width: 2
                    });
                });
                
                if (nodes.length === 0) {
                    showResult('vizStats', '‚ö†Ô∏è No data found in the database.');
                    return;
                }
                
                renderVisualization(nodes, edges);
            }

            async function executeCustomQueryVisualization(query, limit) {
                try {
                    const response = await fetch(`${API_URL}/query`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: query })
                    });
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Query failed');
                    }

                    parseAndRenderVisualization(result, null, limit);

                } catch (error) {
                    showResult('vizStats', `‚ùå Query error: ${error.message}`);
                }
            }

            function parseAndRenderVisualization(nodeResult, edgeResult, limit) {
                const nodes = [];
                const edges = [];
                const nodeMap = new Map(); // Map of node ID to node object
                
                const colors = {
                    'Person': '#667eea',
                    'Company': '#10b981',
                    'Product': '#f59e0b',
                    'default': '#94a3b8'
                };

                // Parse node output (tab-separated format)
                if (nodeResult && nodeResult.output) {
                    const lines = nodeResult.output.split('\n');
                    let isHeader = false;
                    let headerProcessed = false;
                    
                    for (const line of lines) {
                        // Skip metadata lines
                        if (line.includes('query result') || line.includes('etime') || 
                            line.includes('newQuery') || line.includes('WHERES') ||
                            line.includes('[Timing]') || line.includes('[Postgres') ||
                            line.includes('===') || !line.trim()) {
                            continue;
                        }
                        
                        // Skip header row (contains "_0" etc)
                        if (line.includes('_0') && !headerProcessed) {
                            headerProcessed = true;
                            continue;
                        }
                        
                        // Parse node data (tab-separated: ID in first column)
                        const parts = line.trim().split('\t');
                        if (parts.length > 0 && parts[0]) {
                            const nodeId = parseInt(parts[0].trim());
                            if (!isNaN(nodeId) && !nodeMap.has(nodeId)) {
                                // We don't have label info from this query, so fetch it or use default
                                nodeMap.set(nodeId, {
                                    id: nodeId,
                                    label: `Node\n#${nodeId}`,
                                    title: `Node ID: ${nodeId}`,
                                    color: colors['default'],
                                    shape: 'dot',
                                    size: 20
                                });
                            }
                        }
                    }
                }

                // Parse edge output (tab-separated format: from_id, to_id, edge_id)
                if (edgeResult && edgeResult.output) {
                    const lines = edgeResult.output.split('\n');
                    let headerProcessed = false;
                    
                    for (const line of lines) {
                        // Skip metadata lines
                        if (line.includes('query result') || line.includes('etime') || 
                            line.includes('newQuery') || line.includes('WHERES') ||
                            line.includes('[Timing]') || line.includes('[Postgres') ||
                            line.includes('===') || !line.trim()) {
                            continue;
                        }
                        
                        // Skip header row
                        if (line.includes('_0') && !headerProcessed) {
                            headerProcessed = true;
                            continue;
                        }
                        
                        // Parse edge data (tab-separated: from_id, to_id, edge_id)
                        const parts = line.trim().split('\t');
                        if (parts.length >= 3) {
                            const fromId = parseInt(parts[0].trim());
                            const toId = parseInt(parts[1].trim());
                            const edgeId = parseInt(parts[2].trim());
                            
                            if (!isNaN(fromId) && !isNaN(toId) && !isNaN(edgeId)) {
                                // Add nodes if they don't exist
                                if (!nodeMap.has(fromId)) {
                                    nodeMap.set(fromId, {
                                        id: fromId,
                                        label: `#${fromId}`,
                                        title: `Node ${fromId}`,
                                        color: colors['default'],
                                        shape: 'dot',
                                        size: 20
                                    });
                                }
                                if (!nodeMap.has(toId)) {
                                    nodeMap.set(toId, {
                                        id: toId,
                                        label: `#${toId}`,
                                        title: `Node ${toId}`,
                                        color: colors['default'],
                                        shape: 'dot',
                                        size: 20
                                    });
                                }
                                
                                // Add edge
                                edges.push({
                                    id: edgeId,
                                    from: fromId,
                                    to: toId,
                                    label: '',
                                    arrows: 'to',
                                    color: { color: '#999' }
                                });
                            }
                        }
                    }
                }

                // Convert map to array
                nodes.push(...Array.from(nodeMap.values()));

                // If we got no data, show message
                if (nodes.length === 0) {
                    showResult('vizStats', '‚ö†Ô∏è No data found. Try connecting to a database first.');
                    return;
                }

                renderVisualization(nodes, edges);
            }

            function generateSampleVisualization(limit) {
                // Generate nodes
                const nodes = [];
                const edges = [];

                const colors = {
                    'Person': '#667eea',
                    'Company': '#10b981',
                    'Product': '#f59e0b'
                };

                // Create nodes
                for (let i = 1; i <= Math.min(limit, 50); i++) {
                    const type = i <= 30 ? 'Person' : (i <= 40 ? 'Company' : 'Product');
                    nodes.push({
                        id: i,
                        label: `${type} ${i}`,
                        title: `Type: ${type}<br>ID: ${i}`,
                        color: colors[type],
                        shape: type === 'Person' ? 'dot' : (type === 'Company' ? 'diamond' : 'square'),
                        size: 20
                    });
                }

                // Create edges
                for (let i = 1; i <= 30; i++) {
                    const from = Math.floor(Math.random() * 30) + 1;
                    const to = Math.floor(Math.random() * 50) + 1;
                    if (from !== to) {
                        edges.push({
                            id: 1000 + i,
                            from: from,
                            to: to,
                            label: i % 3 === 0 ? 'knows' : (i % 3 === 1 ? 'works_at' : 'bought'),
                            arrows: 'to',
                            color: { color: '#999' }
                        });
                    }
                }

                renderVisualization(nodes, edges);
            }

            function renderVisualization(nodes, edges) {
                const container = document.getElementById('graphContainer');

                const data = {
                    nodes: new vis.DataSet(nodes),
                    edges: new vis.DataSet(edges)
                };

                const options = {
                    nodes: {
                        font: {
                            size: 14,
                            color: '#333'
                        },
                        borderWidth: 2,
                        borderWidthSelected: 4
                    },
                    edges: {
                        width: 2,
                        smooth: {
                            type: 'continuous'
                        },
                        font: {
                            size: 12,
                            align: 'middle'
                        }
                    },
                    physics: {
                        stabilization: {
                            iterations: 100
                        },
                        barnesHut: {
                            gravitationalConstant: -2000,
                            springConstant: 0.001,
                            springLength: 200
                        }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 100
                    }
                };

                network = new vis.Network(container, data, options);
                visualizationData = data;

                // Add click event
                network.on('click', function (params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        const node = data.nodes.get(nodeId);
                        alert(`Node Details:\n${JSON.stringify(node, null, 2)}`);
                    }
                });

                showResult('vizStats', `‚úÖ Visualization complete! Nodes: ${nodes.length}, Edges: ${edges.length}`);
            }

            function clearVisualization() {
                if (network) {
                    network.destroy();
                    network = null;
                }
                document.getElementById('vizStats').classList.add('hidden');
            }

            function exportVisualization() {
                if (!network) {
                    alert('Please create a visualization first');
                    return;
                }

                const canvas = document.querySelector('#graphContainer canvas');
                if (canvas) {
                    const link = document.createElement('a');
                    link.download = 'graph-visualization.png';
                    link.href = canvas.toDataURL();
                    link.click();
                    showResult('vizStats', '‚úÖ Graph exported as PNG!');
                }
            }

        // Initialize
        checkHealth();
    </script>
</body>
</html>

